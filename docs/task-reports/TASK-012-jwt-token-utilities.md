# Task 012: JWT 토큰 유틸리티 구현

**완료일**: 2025-12-19
**관련 파일**: backend/src/utils/jwt.py, backend/tests/unit/test_jwt.py, backend/requirements.txt

## 무엇을 만들었나요?

사용자 인증에 필요한 JWT(JSON Web Token) 토큰을 생성하고 검증하는 유틸리티 함수들을 만들었습니다.

**핵심 기능**:
1. **액세스 토큰 생성** - 짧은 수명(기본 15분)의 인증 토큰 생성
2. **리프레시 토큰 생성** - 긴 수명(기본 7일)의 갱신용 토큰 생성
3. **토큰 검증** - 토큰이 유효하고 만료되지 않았는지 확인
4. **토큰 디코딩** - 토큰에서 사용자 정보 추출

---

## 왜 이렇게 만들었나요?

### JWT를 선택한 이유

웹사이트에 로그인할 때를 생각해보세요. 로그인 후 페이지를 이동할 때마다 "당신이 로그인한 사용자가 맞나요?"를 확인해야 합니다.

전통적인 방식은 서버가 "로그인 기록장"을 들고 있다가 매번 확인하는 것입니다. 하지만 JWT는 **신분증**처럼 작동합니다:
- 사용자가 로그인하면 서버가 "신분증"(JWT 토큰)을 발급
- 이후 요청 시 사용자가 신분증만 제시하면 됨
- 서버는 신분증의 진위만 확인하면 되고, 별도로 기록을 찾을 필요가 없음

이 방식의 장점:
- **빠름** - 서버가 데이터베이스를 뒤질 필요 없음
- **확장성** - 여러 서버가 있어도 모두 같은 신분증을 인식
- **안전함** - 위조가 어려운 디지털 서명 사용

### 두 종류의 토큰을 사용하는 이유

**실생활 비유**: 은행 ATM 카드와 비밀번호를 생각해보세요.
- **액세스 토큰** = ATM 카드 (15분 유효)
  - 자주 사용하지만 짧은 시간만 유효
  - 도난당해도 15분 후엔 쓸모없어짐
- **리프레시 토큰** = 비밀번호 (7일 유효)
  - 가끔 사용하며 오래 유효
  - 새 카드를 받을 때만 사용

---

## 어떻게 작동하나요?

### 토큰 생성 과정

```
사용자 로그인 요청
    ↓
사용자 ID + 만료 시간 + 추가 정보 준비
    ↓
비밀 키로 디지털 서명 생성 (위조 방지)
    ↓
JWT 토큰 문자열 생성
    ↓
사용자에게 전달 (쿠키에 저장)
```

### 토큰 검증 과정

```
사용자가 토큰 제시
    ↓
서명 확인 (위조되지 않았는지)
    ↓
만료 시간 확인 (아직 유효한지)
    ↓
사용자 ID 추출
    ↓
인증 완료 또는 거부
```

---

## 테스트는 어떻게 했나요?

### RED 단계: 실패하는 테스트 작성

먼저 18개의 테스트를 작성했습니다:
- 토큰 생성 테스트 7개
- 토큰 검증 테스트 5개
- 토큰 디코딩 테스트 4개
- 데이터 모델 테스트 2개

**예시 테스트**:
```python
def test_create_access_token_with_default_expiration():
    """액세스 토큰이 기본 만료 시간으로 생성되는지 테스트"""
    token = create_access_token(user_id=123)

    assert isinstance(token, str)
    payload = decode_token(token)
    assert payload.user_id == 123
```

실행 결과: 모듈을 찾을 수 없음 (아직 구현 전)

### GREEN 단계: 최소한의 구현으로 테스트 통과

`backend/src/utils/jwt.py` 파일을 생성하고 구현:
- 환경 변수에서 설정 로드
- `python-jose` 라이브러리로 JWT 인코딩/디코딩
- 타임존 인식 날짜 처리 (`datetime.now(UTC)`)

실행 결과: 18개 테스트 모두 통과 (0.06초)

---

## 수정된 파일

### 새로 생성된 파일:
1. **backend/src/utils/jwt.py** - JWT 토큰 생성/검증/디코딩 함수, TokenData 모델
2. **backend/src/utils/__init__.py** - utils 모듈 초기화
3. **backend/tests/unit/test_jwt.py** - 18개 단위 테스트

### 수정된 파일:
1. **backend/requirements.txt** - python-jose[cryptography] 의존성 추가

---

## 관련 개념

### JWT (JSON Web Token)란?

**실생활 비유**: 놀이공원 입장권을 생각해보세요.
- 입장권에는 이름, 입장 시간, 유효 기간이 인쇄되어 있음
- 위조 방지 홀로그램(디지털 서명)이 있음
- 놀이기구 직원은 입장권만 보고 탑승 허용 여부를 판단

### 환경 변수 (Environment Variables)

프로그램마다 다를 수 있는 설정값을 코드 밖에 저장하는 방식입니다.
- 코드 = 에어컨 본체 (모든 집에 동일)
- 환경 변수 = 온도 설정 (집마다 다름)

---

## 주의사항

### 1. 비밀 키 관리
```bash
# 절대 이렇게 하지 마세요
JWT_SECRET_KEY=secret123

# 이렇게 안전한 키를 사용하세요
JWT_SECRET_KEY=$(openssl rand -hex 32)
```

### 2. HTTPS 필수
프로덕션 환경에서는 반드시 HTTPS를 사용해야 합니다.

### 3. 토큰 만료 시간 설정
- 너무 길면 보안 위험 증가
- 너무 짧으면 사용자 불편 증가
- 현재 설정: 액세스 15분, 리프레시 7일

---

## 다음 단계

T012 완료 후 다음 작업:
- **T013**: 비밀번호 해싱 유틸리티 (bcrypt)
- **T014**: FastAPI 앱 초기화
- **T023-T027**: 사용자 모델 및 인증 서비스 (이 JWT 유틸리티 사용)
