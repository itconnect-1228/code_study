# Task 017: Celery 앱과 Redis 연결 설정

**작업 완료일**: 2025-11-20
**관련 이슈**: Phase 2 - Foundational (Base Infrastructure)
**TDD 사이클**: RED → GREEN

---

## 무엇을 만들었나요?

백그라운드에서 긴 작업을 처리할 수 있는 Celery 앱을 설정했습니다. 이는 AI가 코드를 분석해서 학습 문서를 만드는 것처럼 시간이 오래 걸리는 작업을 사용자가 기다리지 않고도 진행할 수 있게 해주는 시스템입니다.

식당을 생각해보세요. 손님이 주문하면 주방에서 요리를 만드는 동안 손님은 테이블에서 편하게 기다릴 수 있죠. 여기서 Redis는 주문을 적어 넣는 주문서 보관함이고, Celery는 그 주문서를 보고 요리하는 주방장입니다.

---

## 왜 이렇게 만들었나요?

우리 플랫폼의 핵심 기능은 AI가 코드를 분석해서 초보자를 위한 학습 문서를 만드는 것입니다. 이 작업은 보통 1~3분 정도 걸립니다. 만약 사용자가 코드를 업로드하고 웹 브라우저가 3분 동안 멈춰있다면 답답할 것입니다.

그래서 "나중에 처리할게요"라고 말하고, 사용자는 다른 일을 할 수 있게 만들었습니다. 사용자가 다른 프로젝트를 보거나 이전 문서를 읽는 동안, 백그라운드에서 Celery가 조용히 문서를 생성합니다.

---

## 어떻게 작동하나요?

1. **Redis 메시지 브로커**: 처리할 작업들을 줄 세워서 보관합니다 (대기 번호표 같은 역할)
2. **Celery 워커**: Redis에서 작업을 하나씩 꺼내서 처리합니다 (주방장이 주문서를 보고 요리하는 것처럼)
3. **결과 저장**: 작업이 끝나면 결과를 다시 Redis에 저장합니다 (요리가 완성되면 서빙 대기 공간에 놓는 것처럼)

우리는 다음과 같이 설정했습니다:
- **작업 시간 제한**: 10분 넘게 걸리는 작업은 자동으로 취소됩니다 (무한정 기다리지 않도록)
- **안전한 직렬화**: JSON 형식만 사용해서 보안 문제를 예방합니다
- **늦은 확인**: 워커가 작업을 완전히 끝낸 후에만 "처리했어요"라고 표시합니다 (중간에 문제가 생기면 다시 처리할 수 있도록)
- **적은 선점**: 한 번에 하나의 작업만 가져옵니다 (AI 작업은 오래 걸리므로 여러 개를 미리 가져오면 다른 워커들이 놀게 됨)

---

## 어떻게 테스트했나요?

**TDD 방식**으로 개발했습니다:

### 🔴 RED 단계
먼저 10개의 테스트를 작성했습니다:
- Celery 앱이 제대로 만들어지는지
- 이름이 "codelearn"인지
- Redis 연결이 설정되었는지
- JSON 직렬화가 되는지
- UTC 시간대를 사용하는지
- 타임아웃 설정이 있는지
- 작업 추적이 활성화되었는지

모든 테스트가 실패했습니다 (아직 구현 안 했으니까요).

### 🟢 GREEN 단계
`backend/src/tasks/celery_app.py` 파일을 만들어서 Celery 앱을 구현했습니다. 환경 변수에서 Redis 주소와 타임아웃 값을 읽어오고, 모든 설정을 적용했습니다.

테스트를 다시 돌렸더니 10개 모두 통과! 코드 커버리지 100% 달성!

---

## 수정/생성된 파일

**생성된 파일:**
- `backend/src/tasks/__init__.py` - tasks 패키지 초기화
- `backend/src/tasks/celery_app.py` - Celery 앱 설정 (65줄)
- `backend/tests/unit/tasks/test_celery_app.py` - 테스트 파일 (10개 테스트)

**사용된 기술:**
- Celery 5.3.0 - 분산 작업 큐
- Redis 5.0.0 - 메시지 브로커 및 결과 저장소
- pydantic-settings - 환경 변수 관리

---

## 관련 개념

**메시지 큐(Message Queue)**: 마트 계산대 줄처럼, 처리할 작업들을 순서대로 보관하는 시스템입니다.

**비동기 처리(Async Processing)**: 빨래를 돌려놓고 다른 일을 하는 것처럼, 작업을 시작해놓고 기다리는 동안 다른 일을 할 수 있게 하는 방식입니다.

**워커(Worker)**: 실제로 일을 하는 직원입니다. 여러 명의 워커를 동시에 돌려서 작업을 빠르게 처리할 수 있습니다.

---

## 주의사항

1. **타임아웃 설정 중요**: AI 작업이 무한정 걸리면 시스템이 마비될 수 있어서 10분 제한을 뒀습니다.
2. **Pickle 사용 금지**: 보안을 위해 JSON만 사용합니다. Pickle은 악성 코드 실행 위험이 있습니다.
3. **Redis 연결 필요**: Celery를 쓰려면 Redis 서버가 실행 중이어야 합니다 (Docker Compose로 시작).

---

## 다음 단계

이제 기본 설정은 끝났으니, 실제 작업들을 정의할 차례입니다:

1. **문서 생성 작업** (`document_generation.py`): 업로드된 코드를 분석해서 7장짜리 학습 문서를 만드는 작업
2. **연습 문제 생성 작업** (`practice_generation.py`): 문서를 바탕으로 5개의 연습 문제를 만드는 작업
3. **휴지통 정리 작업** (`trash_cleanup.py`): 30일 지난 삭제된 항목을 영구 삭제하는 스케줄 작업

지금은 빈 주방을 만든 거고, 앞으로 요리사들이 만들 수 있는 메뉴(작업들)를 추가할 것입니다!
