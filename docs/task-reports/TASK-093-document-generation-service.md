# T093: 문서 생성 서비스 구현

**완료일**: 2025-12-26
**담당**: AI Code Learning Platform
**상태**: 완료

## 무엇을 만들었나요?

코드를 분석해서 7장 구성의 학습 문서를 자동으로 만들어주는 서비스를 구현했습니다. 마치 선생님이 학생을 위해 교재를 만드는 것처럼, AI가 코드를 보고 초보자도 이해할 수 있는 설명 문서를 생성합니다.

## 왜 이렇게 만들었나요?

AI를 사용해서 코드를 생성하는 사람들이 많지만, 그 코드가 무엇을 하는지 이해하지 못하는 경우가 많습니다. 이 서비스는 그런 분들을 위해 만들어졌습니다.

특히 신뢰성을 위해 **재시도 로직**을 넣었습니다. AI 서비스는 가끔 오류가 나거나 응답이 느릴 수 있는데, 이런 경우에 자동으로 다시 시도해서 사용자가 기다리다 포기하는 일이 없도록 했습니다.

## 어떻게 작동하나요?

1. **코드 입력**: 사용자가 코드를 업로드하면 서비스가 받습니다
2. **프롬프트 생성**: PromptBuilder가 AI에게 보낼 질문을 만듭니다
3. **AI 호출**: GeminiClient를 통해 Google의 AI에게 분석을 요청합니다
4. **재시도 처리**: 오류가 나면 자동으로 최대 3번까지 다시 시도합니다
5. **응답 검증**: AI의 응답이 올바른 형식인지 확인합니다
6. **저장**: 완성된 문서를 데이터베이스에 저장합니다

비유하자면, 음식 배달 서비스와 비슷합니다. 주문(코드)을 받으면 요리사(AI)에게 전달하고, 요리가 완성되면 품질을 확인한 뒤 고객에게 배달(저장)합니다. 중간에 문제가 생기면 다시 요리를 부탁합니다.

## 테스트는 어떻게 했나요?

TDD(테스트 주도 개발) 방식으로 20개의 테스트를 작성했습니다:

- **문서 생성 테스트**: 문서가 제대로 생성되고 저장되는지
- **재시도 테스트**: 오류가 나면 자동으로 재시도하는지
- **검증 테스트**: 잘못된 응답을 거부하는지
- **상태 추적 테스트**: 생성 진행 상황을 제대로 알려주는지

모든 테스트가 통과했습니다!

## 수정한 파일들

**새로 만든 파일:**
- `backend/src/services/document/__init__.py` - 문서 서비스 패키지
- `backend/src/services/document/document_generation_service.py` - 핵심 서비스 코드
- `backend/tests/unit/services/document/__init__.py` - 테스트 패키지
- `backend/tests/unit/services/document/test_document_generation_service.py` - 테스트 코드

**수정한 파일:**
- `backend/src/services/__init__.py` - DocumentGenerationService 추가
- `backend/tests/conftest.py` - JSONB 타입 SQLite 호환 처리 추가

## 관련 개념

- **Service Layer Pattern**: 비즈니스 로직을 API 계층과 분리하는 설계 패턴
- **Retry Logic**: 실패한 작업을 자동으로 다시 시도하는 로직
- **Exponential Backoff**: 재시도 간격을 점점 늘려가는 기법 (1초 → 2초 → 4초)
- **JSON Validation**: AI 응답이 올바른 형식인지 확인하는 과정

## 주의할 점

- AI 응답이 가끔 JSON 형식이 아닐 수 있어서 마크다운 블록 제거 로직이 포함되어 있습니다
- 재시도 로직 때문에 실제 응답 시간이 길어질 수 있습니다 (최대 3분)
- 이미 완료된 문서가 있으면 새로 생성하지 않고 오류를 발생시킵니다

## 다음 단계

- T094: Celery 비동기 작업으로 문서 생성 분리
- T095: 문서 생성 큐 관리 서비스 구현
- T097: GET /tasks/{task_id}/document API 엔드포인트 구현
