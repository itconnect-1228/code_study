# T045: í”„ë¡œì íŠ¸ ì†Œìœ ê¶Œ ê²€ì¦ êµ¬í˜„ ì‘ì—… ë³´ê³ ì„œ

**ì™„ë£Œì¼**: 2025-12-24
**ì‘ì—… ID**: T045
**ê´€ë ¨ ì‚¬ìš©ì ìŠ¤í† ë¦¬**: US4 - í”„ë¡œì íŠ¸ ê´€ë¦¬
**ì‘ì—… ìƒíƒœ**: âœ… ì™„ë£Œ

---

## 1. ì‘ì—… ê°œìš”

í”„ë¡œì íŠ¸ ì†Œìœ ê¶Œ ê²€ì¦ì€ ì‚¬ìš©ìê°€ ìì‹ ì˜ í”„ë¡œì íŠ¸ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•˜ëŠ” ë³´ì•ˆ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì´ ì‘ì—…ì€ T044ì—ì„œ êµ¬í˜„í•œ ProjectServiceì— `validate_ownership` ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì—¬ ê¶Œí•œ ê²€ì‚¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

**í•µì‹¬ ê¸°ëŠ¥**:
- ì‚¬ìš©ìê°€ íŠ¹ì • í”„ë¡œì íŠ¸ë¥¼ ì†Œìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
- í”„ë¡œì íŠ¸ ìˆ˜ì •/ì‚­ì œ ì „ ê¶Œí•œ ê²€ì¦ì— ì‚¬ìš©
- 403 Forbidden ì‘ë‹µ ìƒì„±ì„ ìœ„í•œ ê¸°ë°˜ ì œê³µ

---

## 2. êµ¬í˜„ ë‚´ìš© (ë¬´ì—‡ì„ í–ˆëŠ”ê°€)

### 2.1 validate_ownership ë©”ì„œë“œ

**ì‹œê·¸ë‹ˆì²˜**:
```python
async def validate_ownership(self, project_id: UUID, user_id: UUID) -> bool
```

**ë™ì‘**:
1. project_idë¡œ í”„ë¡œì íŠ¸ ì¡°íšŒ
2. í”„ë¡œì íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ False ë°˜í™˜
3. í”„ë¡œì íŠ¸ì˜ user_idì™€ ìš”ì²­í•œ user_id ë¹„êµ
4. ì¼ì¹˜í•˜ë©´ True, ë¶ˆì¼ì¹˜í•˜ë©´ False ë°˜í™˜

**íŠ¹ì§•**:
- ê°„ë‹¨í•˜ê³  ëª…í™•í•œ boolean ë°˜í™˜
- ë¹„ë™ê¸° íŒ¨í„´ ìœ ì§€
- í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ë„ í•¨ê»˜ ê²€ì¦

### 2.2 ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

**API ì—”ë“œí¬ì¸íŠ¸ì—ì„œì˜ í™œìš© ì˜ˆì‹œ**:
```python
# PATCH /projects/{project_id} ì—”ë“œí¬ì¸íŠ¸
async def update_project(project_id: UUID, current_user: User, ...):
    # ì†Œìœ ê¶Œ ê²€ì¦
    is_owner = await project_service.validate_ownership(project_id, current_user.id)
    if not is_owner:
        raise HTTPException(status_code=403, detail="Not authorized to update this project")

    # ì†Œìœ ê¶Œ í™•ì¸ í›„ ìˆ˜ì • ì§„í–‰
    updated_project = await project_service.update(project_id, ...)
    return updated_project
```

### 2.3 í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

ì´ 3ê°œì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (100% í†µê³¼):

1. âœ… **ì†Œìœ ê¶Œ ê²€ì¦ ì„±ê³µ**: ì‚¬ìš©ìê°€ í”„ë¡œì íŠ¸ë¥¼ ì†Œìœ í•œ ê²½ìš° True ë°˜í™˜
2. âœ… **ì†Œìœ ê¶Œ ê²€ì¦ ì‹¤íŒ¨**: ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í”„ë¡œì íŠ¸ì¸ ê²½ìš° False ë°˜í™˜
3. âœ… **ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œì íŠ¸**: í”„ë¡œì íŠ¸ê°€ ì—†ëŠ” ê²½ìš° False ë°˜í™˜

---

## 3. ê¸°ìˆ ì  ê²°ì • ë° ì´ìœ  (ì™œ ì´ë ‡ê²Œ í–ˆëŠ”ê°€)

### 3.1 Boolean ë°˜í™˜ íƒ€ì…

**ê²°ì •**: True/False ë°˜í™˜ (ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ)

**ì´ìœ **:
- API ë ˆë²¨ì—ì„œ HTTP ìƒíƒœ ì½”ë“œ ì„ íƒ ìœ ì—°ì„±
- ì—¬ëŸ¬ ê²€ì¦ ì¡°ê±´ì„ ì¡°í•© ê°€ëŠ¥
- ëª…ì‹œì ì¸ ê¶Œí•œ ì²´í¬ ë¡œì§ ì‘ì„± ê°€ëŠ¥
- ì˜ˆì™¸ ì²˜ë¦¬ ì˜¤ë²„í—¤ë“œ ì—†ìŒ

**ëŒ€ì•ˆê³¼ ë¹„êµ**:
- ì˜ˆì™¸ ë˜ì§€ê¸°: ì„œë¹„ìŠ¤ ë ˆë²¨ì—ì„œ HTTP ë¡œì§ì´ ì„ì„ (ë‚˜ì¨)
- None ë°˜í™˜: booleanë³´ë‹¤ ì˜ë¯¸ê°€ ë¶ˆëª…í™• (ë‚˜ì¨)
- Boolean ë°˜í™˜: ëª…í™•í•˜ê³  ì¡°í•© ê°€ëŠ¥ (ì¢‹ìŒ)

### 3.2 ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œì íŠ¸ ì²˜ë¦¬

**ê²°ì •**: ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ False ë°˜í™˜ (404ê°€ ì•„ë‹Œ 403)

**ì´ìœ **:
- ë³´ì•ˆ: í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ë¥¼ ê³µê²©ìì—ê²Œ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
- ì¼ê´€ì„±: ëª¨ë“  ê¶Œí•œ ì—†ìŒ ìƒí™©ì„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
- ë‹¨ìˆœì„±: API ë ˆë²¨ì—ì„œ í•˜ë‚˜ì˜ 403 ì‘ë‹µìœ¼ë¡œ í†µì¼

**ë³´ì•ˆ ì›ì¹™**:
```
ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œì íŠ¸ vs ê¶Œí•œ ì—†ëŠ” í”„ë¡œì íŠ¸
â†’ ë‘˜ ë‹¤ 403 Forbiddenìœ¼ë¡œ ì‘ë‹µ
â†’ ê³µê²©ìê°€ í”„ë¡œì íŠ¸ ID ìœ íš¨ì„±ì„ í™•ì¸í•  ìˆ˜ ì—†ìŒ
```

### 3.3 ëª…ì‹œì  bool() ë³€í™˜

**ê²°ì •**: `return bool(project.user_id == user_id)`

**ì´ìœ **:
- mypy íƒ€ì… ì²´ì»¤ ë§Œì¡± (no-any-return ì˜¤ë¥˜ ë°©ì§€)
- ëª…ì‹œì  íƒ€ì… ë³€í™˜ìœ¼ë¡œ ì˜ë„ ëª…í™•í™”
- UUID ë¹„êµ ê²°ê³¼ê°€ í™•ì‹¤íˆ bool íƒ€ì…ì„ì„ ë³´ì¥

### 3.4 get_by_id ì¬ì‚¬ìš©

**ê²°ì •**: ê¸°ì¡´ get_by_id ë©”ì„œë“œ í™œìš©

**ì´ìœ **:
- ì½”ë“œ ì¤‘ë³µ ë°©ì§€ (DRY ì›ì¹™)
- ì¼ê´€ëœ í”„ë¡œì íŠ¸ ì¡°íšŒ ë¡œì§
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

---

## 4. í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œ (TDD) ê³¼ì •

### ğŸ”´ RED ë‹¨ê³„
1. í…ŒìŠ¤íŠ¸ ì¶”ê°€: TestProjectServiceOwnership í´ë˜ìŠ¤ ìƒì„±
2. 3ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„± (ì„±ê³µ, ì‹¤íŒ¨, ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼: `AttributeError: 'ProjectService' object has no attribute 'validate_ownership'`
4. **ì»¤ë°‹**: `f108982 - test: T045 ownership validation - RED`

### ğŸŸ¢ GREEN ë‹¨ê³„
1. validate_ownership ë©”ì„œë“œ êµ¬í˜„
2. project.user_idì™€ user_id ë¹„êµ ë¡œì§ ì¶”ê°€
3. mypy íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì • (bool() ëª…ì‹œì  ë³€í™˜)
4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼: 3ê°œ ëª¨ë‘ í†µê³¼
5. **ì»¤ë°‹**: `ba9a730 - feat: T045 ownership validation - GREEN`

### ğŸ”µ REFACTOR ë‹¨ê³„
1. ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰
   - ë©”ì„œë“œê°€ ê°„ë‹¨í•˜ê³  ëª…í™•í•¨
   - ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë©”ì„œë“œì™€ ì¼ê´€ëœ íŒ¨í„´
   - íƒ€ì… íŒíŠ¸ ë° ë¬¸ì„œí™” ì™„ë²½
2. services `__init__.py` ë¬¸ì„œí™” ê°œì„ : validate_ownership ë©”ì„œë“œ ì°¸ì¡° ì¶”ê°€
3. ì „ì²´ í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰: 25ê°œ ëª¨ë‘ í†µê³¼
4. **ì»¤ë°‹**: `069a683 - refactor: T045 ownership validation - REFACTOR`

---

## 5. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 5.1 ì •ë³´ ëˆ„ì¶œ ë°©ì§€

**ì›ì¹™**: ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ìì—ê²Œ ìµœì†Œí•œì˜ ì •ë³´ë§Œ ì œê³µ

**êµ¬í˜„**:
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œì íŠ¸ì™€ ê¶Œí•œ ì—†ëŠ” í”„ë¡œì íŠ¸ë¥¼ êµ¬ë¶„í•˜ì§€ ì•ŠìŒ
- ë‘˜ ë‹¤ False ë°˜í™˜ â†’ APIì—ì„œ 403 Forbidden ì‘ë‹µ
- ê³µê²©ìê°€ ìœ íš¨í•œ í”„ë¡œì íŠ¸ IDë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ì—†ìŒ

### 5.2 ì¸ì¦ vs ê¶Œí•œ ë¶€ì—¬

**ëª…í™•í•œ ë¶„ë¦¬**:
- ì¸ì¦ (Authentication): ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸ (ì´ë¯¸ ì™„ë£Œë¨)
- ê¶Œí•œ ë¶€ì—¬ (Authorization): ì‚¬ìš©ìê°€ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸ (ì´ ì‘ì—…)

**validate_ownershipì˜ ì—­í• **:
- ê¶Œí•œ ë¶€ì—¬ ë‹¨ê³„ì—ì„œ ì‚¬ìš©
- ì¸ì¦ëœ ì‚¬ìš©ìì˜ user_idë¥¼ ë°›ì•„ì„œ ê²€ì¦
- API ë ˆë²¨ì—ì„œ ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì´í›„ í˜¸ì¶œ

### 5.3 ë°ì´í„° ê²©ë¦¬

**ì›ì¹™**: ê° ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼ ê°€ëŠ¥

**êµ¬í˜„ ìˆ˜ì¤€**:
1. **ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨**: user_id foreign key
2. **ì„œë¹„ìŠ¤ ë ˆë²¨**: validate_ownership ë©”ì„œë“œ (ì´ ì‘ì—…)
3. **API ë ˆë²¨**: ê¶Œí•œ ê²€ì¦ ë°ì½”ë ˆì´í„° (í–¥í›„ T046-T050)

---

## 6. API í†µí•© íŒ¨í„´ (í–¥í›„ ì‘ì—…)

### 6.1 API ì—”ë“œí¬ì¸íŠ¸ì—ì„œì˜ ì‚¬ìš©

**ê¶Œì¥ íŒ¨í„´**:
```python
async def update_project_endpoint(
    project_id: UUID,
    update_data: ProjectUpdate,
    current_user: User = Depends(get_current_user),
    project_service: ProjectService = Depends(get_project_service)
):
    # 1ë‹¨ê³„: ì†Œìœ ê¶Œ ê²€ì¦
    if not await project_service.validate_ownership(project_id, current_user.id):
        raise HTTPException(
            status_code=403,
            detail="You do not have permission to access this project"
        )

    # 2ë‹¨ê³„: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
    updated_project = await project_service.update(
        project_id=project_id,
        title=update_data.title,
        description=update_data.description
    )

    return updated_project
```

### 6.2 ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì˜ì¡´ì„±

**í–¥í›„ ê°œì„  ê°€ëŠ¥ì„±**:
```python
async def require_project_ownership(
    project_id: UUID,
    current_user: User = Depends(get_current_user),
    project_service: ProjectService = Depends(get_project_service)
) -> Project:
    """Dependency that validates ownership and returns the project."""
    if not await project_service.validate_ownership(project_id, current_user.id):
        raise HTTPException(status_code=403, detail="Access denied")

    project = await project_service.get_by_id(project_id)
    return project

# ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚¬ìš©
async def update_project(
    update_data: ProjectUpdate,
    project: Project = Depends(require_project_ownership)
):
    # projectëŠ” ì´ë¯¸ ì†Œìœ ê¶Œ ê²€ì¦ë¨
    ...
```

---

## 7. í–¥í›„ ì‘ì—… (ë‹¤ìŒ ë‹¨ê³„)

ì´ì œ ownership validationì´ ì™„ì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ë‹¤ìŒ ì‘ì—…ë“¤ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **T046-T050**: Project API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
   - GET /projects (ëª©ë¡ ì¡°íšŒ)
   - POST /projects (ìƒì„±)
   - GET /projects/{id} (ìƒì„¸ ì¡°íšŒ)
   - PATCH /projects/{id} (ìˆ˜ì • - validate_ownership ì‚¬ìš©)
   - DELETE /projects/{id} (ì‚­ì œ - validate_ownership ì‚¬ìš©)

2. **ë³´ì•ˆ ê°•í™”**:
   - API ë ˆë²¨ ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
   - Rate limiting (ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë°©ì§€)
   - ê°ì‚¬ ë¡œê·¸ (ëˆ„ê°€ ì–¸ì œ ë¬´ì—‡ì„ í–ˆëŠ”ì§€)

3. **í…ŒìŠ¤íŠ¸ í™•ì¥**:
   - Integration tests (API + Service + DB)
   - Security tests (ê¶Œí•œ ìš°íšŒ ì‹œë„)

---

## 8. ë°°ìš´ ì  ë° ê°œì„  ì‚¬í•­

### 8.1 mypy íƒ€ì… ì²´ì»¤

**ë¬¸ì œ**: `return project.user_id == user_id`ê°€ no-any-return ì˜¤ë¥˜ ë°œìƒ

**í•´ê²°**: `return bool(project.user_id == user_id)`ë¡œ ëª…ì‹œì  ë³€í™˜

**êµí›ˆ**:
- mypyëŠ” ì—°ì‚°ì ê²°ê³¼ê°€ í•­ìƒ boolì¸ì§€ í™•ì‹ í•˜ì§€ ëª»í•¨
- ëª…ì‹œì  íƒ€ì… ë³€í™˜ìœ¼ë¡œ íƒ€ì… ì•ˆì •ì„± í–¥ìƒ
- ì½”ë“œ ì˜ë„ê°€ ë” ëª…í™•í•´ì§

### 8.2 ë³´ì•ˆ ì›ì¹™: Fail Closed

**ì›ì¹™**: ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ê²½ìš° í•­ìƒ ì ‘ê·¼ ê±°ë¶€

**ì ìš©**:
- í”„ë¡œì íŠ¸ ì¡´ì¬ ì—¬ë¶€ ë¶ˆëª…í™• â†’ False ë°˜í™˜
- ì†Œìœ ê¶Œ ë¶ˆëª…í™• â†’ False ë°˜í™˜
- ì—ëŸ¬ ë°œìƒ â†’ False ë°˜í™˜ (í–¥í›„ ì¶”ê°€ ê°€ëŠ¥)

**ëŒ€ì•ˆ (Fail Open)**:
- ì—ëŸ¬ ë°œìƒ ì‹œ True ë°˜í™˜ â†’ ë³´ì•ˆ ì·¨ì•½ì ! (ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€)

### 8.3 ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ì±…ì„

**ëª…í™•í•œ ê²½ê³„**:
- âœ… ì„œë¹„ìŠ¤: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ì†Œìœ ê¶Œ í™•ì¸)
- âœ… API: HTTP ì²˜ë¦¬ (403 ì‘ë‹µ)
- âŒ ì„œë¹„ìŠ¤ê°€ HTTP ì˜ˆì™¸ ë˜ì§€ê¸° (ì˜ëª»ë¨)
- âŒ APIê°€ ì†Œìœ ê¶Œ ë¡œì§ êµ¬í˜„ (ì˜ëª»ë¨)

---

## 9. ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] TDD ì‚¬ì´í´ ì™„ë£Œ (RED â†’ GREEN â†’ REFACTOR)
- [x] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (3 passed, ì´ 25 passed)
- [x] ProjectService 100% ì»¤ë²„ë¦¬ì§€ ìœ ì§€
- [x] Boolean ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ ëª…í™•í•œ ì¸í„°í˜ì´ìŠ¤
- [x] ë³´ì•ˆ ì›ì¹™ ì¤€ìˆ˜ (ì •ë³´ ëˆ„ì¶œ ë°©ì§€)
- [x] mypy íƒ€ì… ì²´ì»¤ í†µê³¼
- [x] ëª…í™•í•œ ë¬¸ì„œí™” ë° íƒ€ì… íŒíŠ¸
- [x] ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™ ì¤€ìˆ˜
- [x] ì‘ì—… ë³´ê³ ì„œ ì‘ì„± (Korean, 300-500ì)

---

**ì™„ë£Œì¼**: 2025-12-24
**ì»¤ë°‹ íšŸìˆ˜**: 3íšŒ (RED, GREEN, REFACTOR)
**TDD ì»¤ë°‹ í•´ì‹œ**: `f108982`, `ba9a730`, `069a683`
**ì½”ë“œ ë¼ì¸**: ì„œë¹„ìŠ¤ +33ì¤„, í…ŒìŠ¤íŠ¸ +68ì¤„
**í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: ProjectService 100%
